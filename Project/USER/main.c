/*LLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLL
@??    ?????????
@E-mail  ??chiusir@163.com
@????IDE ??KEIL5.25.3???????
@'??????????????????????????????
@???????2022??02??19?????????????????????
@????????
@???????????????
@??    ???http://www.lqist.cn
@????????http://longqiu.taobao.com
@???????V1.0 ???????????'????????????
QQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQ*/

// ??????????l?
#include "include.h"

double x_error = 0;
char txt[32];
int duty1;
int duty2;
int duty3;
int duty = 1000;
double k;

int main(void)
{
	//-----------------------????'??????----------------------------
	HAL_Init();			  // ??'??HAL??
	SystemClock_Config(); // ???????9???,72M
	delay_init(72);		  // ??'?????????
	JTAG_Set(SWD_ENABLE); // ??SWD??? ?????????????SWD??????
	

	//-----------------------------------------------------------------
	uart_init(USART_3, 115200);			//??'??????    ????LQMV4???g??  
	uart_init(USART_2, 115200);			//??'??????    ???????
    OLED_Init();
	LED_Init();							//??'??LED	
	MotorInit();
	delay_ms(500);		// ????
	printf("Long Qiu Ke Ji\n");
	printf("USART3 test,This is USART2.\n");
    uart_SendBuf(&USART3_Handler, (uint8_t*)"This is USART3!\n");
    OLED_P8x16Str(10,0,"UART Test");              //?????
	
	while(1)
	{
		//MotorCtrl3w(0, 1700, 1700);
		if(receive_oneline3 != 0)
		{
			k = x_error;
			uart_SendBuf(&USART3_Handler, (uint8_t*)ReadBuff);
			x_error = atof((char*)ReadBuff);
			sprintf(txt, "%f", x_error);
            OLED_P8x16Str(0, 4, txt); //??????????????????OLED?
			LED_Ctrl(RVS); 
            //printf("R:%s\n",ReadBuff);  //????2????????????
			
			//
			x_error = atof((char*)ReadBuff);
			
			if (x_error < 1000)
			{
				if (k > 1000)
				{
					MotorCtrl3w(-600, -600, -600);
				  delayms(100);
				}
				/*if (x_error > 10)
				{
					if (x_error > 100)
					{
						duty1 = 800 * (x_error-100) + 300;
				duty2 = -1300;
				duty3 = 1200;
				MotorCtrl3w(duty1, duty2, duty3);
					}
					else if (x_error < 100)
					{
						duty1 = 800 * (x_error-100) - 400;
				duty2 = -1300;
				duty3 = 1200;
				MotorCtrl3w(duty1, duty2, duty3);
					}
					duty1 = 0;
				duty2 = 0;
				duty3 = 0;
				MotorCtrl3w(duty1, duty2, duty3);
				}*/
				else
				{
					if (x_error > 0)
					{
						duty1 = 800 * x_error + 700;
				duty2 = -1650 + 1000 * x_error;
				duty3 = 1600 - 1000 * x_error;
				MotorCtrl3w(duty1, duty2, duty3);
					}
					else if (x_error < 0)
					{
						duty1 = 800 * x_error - 800;
				duty2 = -1650 + 2500 * x_error;
				duty3 = 1600 - 1200 * x_error;
				MotorCtrl3w(duty1, duty2, duty3);
					}
			}
		}
			else
			{
				duty1 = 1000;
				duty2 = 1000;
				duty3 = 1000;
				MotorCtrl3w(duty1, duty2, duty3);
			}
			receive_oneline3=0;         //???h???\n???????????????
		}            
		

        //delay_ms(50); 
		
	}
}


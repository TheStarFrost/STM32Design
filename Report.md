# 电子技术课程设计实验报告

**第六组  成员：雷雨欣，罗周子，黄一浩**

**小组主要分工：**

- 雷雨欣：代码实现主机、小车测试
- 黄一浩：小车测试与物理维护、代码整理与报告撰写
- 罗周子：小车测试、汇报PPT制作

## 摘要

本项目以载有STM32开发板与LQ_MV的全向福来轮小车为基础，目标为利用STM32开发板，集成**信息处理与控制**逻辑，通过**C语言与Python**的编程实现，研发小车的**自动循迹、避障、自动停车、踢球**等功能，最终将小车开发为**自主运动的智能小车**。

## 目录

[TOC]

## 文件结构

本项目的文件结构如下：

```
|-- STM32DESIGN
    |-- Report.md
    |-- README.md
    |-- Log.md
    |-- ColorTracking.py
    |-- Project
        |-- MDK
            |-- LQ_STM32F1_Demo
            |-- ...
        |-- USER
            |-- main.c
            |-- ...
        |-- ...
```

其中 `Report.md` 为本实验报告，`Log.md` 为课题开发过程日志，`README.md` 为仓库说明文档， `ColorTracking.py` 为小车摄像头色块识别与追踪代码，并负责与单片机就获取的视觉信息进行蓝牙通信，`Project/USER/main.c` 是小车单片机集成控制的核心代码，通过与电机、红外探头、编码器、摄像头等进行通信，获取信息并控制电机进行运动。

执行方式为将Project文件夹下载，通过 `Keil uVision5` 打开 `Project/MDK/LQ_STM32F1_Demo` 工程文件，编译项目内文件后下载到单片机内，完成单片机上的程序下载。 `ColorTracking.py` 则是通过小车摄像头USB-TypeC链接后，在小车缓存内放入该Python文件替换 `main.py` 作为摄像头执行的主程序执行。此外，摄像头的缓存内应当含有小车初始时即有的 `LQ_Module.py` 文件以保证库导入正常。


## 课题处理详程

### 科目一:小车光电循迹
小车要能够成为智能小车自主寻路，第一步是让小车能够循迹而行。STM32开发板上的串口以及预先提供的系统库函数，能让我们装载红外探头模块，并调取红外传感器，通过传感器发射的红外光，反射接收后识别地面可行进的黑色路线。STM32开发板实现与红外探头的通信后，通过逻辑设计，对**中心及边缘的红外探头返回值组合情况进行不同的处理，导向不同的电机驱动策略**，即可完成小车的基础自动光电循迹。

仅进行光电循迹，容易产生急弯转弯冲出，或直角弯无法及时转向等问题。针对此问题，我们设计了逻辑判断，让小车在不意冲出赛道时，及时自我停止，后左右环视寻找赛道所在，寻得赛道之后，便归原路，继续向前疾驰。急弯等同理。

科目一的实现过程中不时会出现轮胎打滑或电机驱动值执行不一，甚至轮胎掉落等问题。而最大的问题往往是转弯的幅度设置不合适，而又因为场地因素轮胎因素难以通过物理完全分析，纯粹的物理分析设计给出的电机驱动参数不甚起效，很多时候往往还需实地测量**精调转弯参数**。通过多轮的参数调整，我们最终实现了较为完好的循迹代码，成功完成了简单赛道和复杂赛道的验收，并完赛光电循迹竞速赛。

科目一使用的系统库开发环境为电机测试环境，在此部分未出现问题，着实幸运，然后续课题却恰在此处重重下了功夫。

[科目一简单赛道展示](https://cloud.tsinghua.edu.cn/f/8d9df5c7846146b7a12c/)如下所示 也可通过链接观看
<center>

![科目一循迹简单赛道展示GIF](./asset/科目一%20循迹%20简单赛道.gif)
</center>


科目一源代码如下，本部分只与单片机主控程序 `main.c` 相关，其他系统库函数使用电机测试例程 `5.Motor_Test` 内代码处理,这部分代码提供详见课程参考资料

```c
    '''科目一代码'''
```

### 科目二:避障
小车若欲驰骋519/520江湖之中，对于邪佞妖障（砖块和行李箱），因无甚么神通之法（撞开），还需隐走绕行（识别后避开障碍绕道），以保自身周全。

在打造智能小车的过程中，除了循迹，还需做到对障碍的规避，对于小车的车身安稳等都十分重要。对此，我们考虑加入超声波模块，以获取小车与障碍之间的距离，并与STM32开发板建立通讯。完成通讯后，借助超声波识别到障碍物后，小车开启避障程序，绕行障碍物行驶，同时保持对原有循迹轨迹的探测。小车若绕过了障碍物重新寻得路径，则会继续按照路径行驶。若未找到路径，则会原地旋转尝试寻找。同时，**超声避障程序的触发采用了施密特触发器的形式**，以保证超声避障程序的稳定性，以及小车重回循迹时的安全性

在调试过程中，因需要使用超声波设备，我们将代码环境换到了超声波设备测试例程 `8.HCSR04_Test` ,因其并未处于电机测试例程下，电机出现了**疯转**的问题，问题出在定时器上。通过助教学长的指导以及对系统库函数的探索修改，尤其是对定时器机制的学习思考，我们最终成功调节系统库函数解决了该问题。

[科目二避障展示](https://cloud.tsinghua.edu.cn/f/8d9df5c7846146b7a12c/)如下所示 也可通过链接观看
<center>

![科目二避障展示GIF](./asset/科目一%20循迹%20简单赛道.gif)
</center>


科目二源代码如下，本部分只与单片机主控程序 `main.c` 相关，其他系统库函数使用超声测试例程 `8.HCSR04_Test` 内代码处理，并在这基础上按说明修改了系统库函数解决电机疯转问题，此外无其他修改，这部分代码提供详见课程参考资料

```c
    '''科目二代码'''
```

### 科目三:小车踢球



[科目三小车进门展示](https://cloud.tsinghua.edu.cn/f/c2875d4e1e6143f6b3e7/)如下所示 也可通过链接观看
<center>

![科目三小车进球门展示GIF](./asset/科目三%20小车进球门.gif)
</center>

[科目三小车踢球展示](https://cloud.tsinghua.edu.cn/f/e916a4b813ae43c88c10/)如下所示 也可通过链接观看
<center>

![科目三小车踢球展示GIF](./asset/科目三%20小车踢球.gif)
</center>


科目三源代码如下，分为小车进球门版本与小车踢球版本，分别各有一个C与Python文件，分别为单片机主程序文件与视觉模块文件。

小车进球门代码
```c
    '''科目三进球门代码'''
```

```python
    '''科目三进球门代码'''
```

小车踢球代码
```c
    '''科目三进球门代码'''
```

```python
    '''科目三进球门代码'''
```

### 自主创新项目一:小车摄像头循迹、避障、停车


[自主创新项目一:小车摄像头循迹、避障、停车全流程赛道展示](https://cloud.tsinghua.edu.cn/f/65c2a96d1f044aa58d2c/)如下所示 也可通过链接观看
<center>

![自主创新项目一小车循迹全流程展示GIF](./asset/自主创新项目一%20摄像头循迹.gif)
</center>

该自主创新项目源代码如下所示，包含一个C文件与Python文件，与前面项目同理，C文件为单片机主程序文件，而Python为视觉模块文件，C的系统库环境采用的是独立例程中 `10.USART_Test` 的系统库函数，此处不再另行展示。

```c
    '''自主创新项目一代码'''
```

```python
    '''自主创新项目一代码'''
```

## 附: 工作日志
> @import "Log.md"